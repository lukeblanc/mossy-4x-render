name: Mossy 4X Self-Audit

on:
  workflow_dispatch: # manual trigger
    push:
        branches:
              - main
                schedule:
                    - cron: "0 0 * * *" # run every day at midnight UTC

                    jobs:
                      self-audit:
                          runs-on: ubuntu-latest

                              steps:
                                    - name: Checkout repo
                                            uses: actions/checkout@v4

                                                  - name: Run Auditor
                                                          run: |
                                                                    echo "Running Mossy 4X Auditor..."
                                                                              if [ -d "audit-output" ]; then
                                                                                          cp -r audit-output/* .
                                                                                                      echo "✅ Applied audit fixes from audit-output/"
                                                                                                                else
                                                                                                                            echo "ℹ️ No audit-output folder found, nothing to apply."
                                                                                                                                      fi
                                                                                                                                      
                                                                                                                                            - name: Commit & push changes
                                                                                                                                                    uses: stefanzweifel/git-auto-commit-action@v5
                                                                                                                                                            with:
                                                                                                                                                                      commit_message: "fix: auto-audit applied Mossy 4X spec fixes"
                                                                                                                                                                                branch: auto-audit
                                                                                                                                                                                          create_branch: true
                                                                                                                                                                                          
                                                                                                                                                                                                - name: Create Pull Request
                                                                                                                                                                                                        id: create-pr
                                                                                                                                                                                                                uses: peter-evans/create-pull-request@v6
                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                  branch: auto-audit
                                                                                                                                                                                                                                            title: "Automated Audit Fixes"
                                                                                                                                                                                                                                                      body: "This PR contains fixes from the Mossy 4X self-audit workflow."
                                                                                                                                                                                                                                                                base: main
                                                                                                                                                                                                                                                                          draft: false
                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                - name: Enable Auto-merge
                                                                                                                                                                                                                                                                                        uses: peter-evans/enable-pull-request-automerge@v3
                                                                                                                                                                                                                                                                                                with:
                                                                                                                                                                                                                                                                                                          token: ${{ secrets.GITHUB_TOKEN }}
                                                                                                                                                                                                                                                                                                                    pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
                                                                                                                                                                                                                                                                                                                              merge-method: squash
                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                    - name: Delete Branch After Merge
                                                                                                                                                                                                                                                                                                                                            if: success()
                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                              git push origin --delete auto-audit || true
                                                                                                                                                                                                                                                                                                                                                              
